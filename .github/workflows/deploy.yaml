name: Full CD to UI Instance via SSH

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Deploy to EC2 UI Instance
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          envs: APP_DIR,OLLAMA_PRIVATE_IP
          script: |
            set -e
            
            # Export environment variables for use in the script
            export APP_DIR="${{ secrets.APP_DIR }}"
            export OLLAMA_PRIVATE_IP="${{ secrets.OLLAMA_PRIVATE_IP }}"
            
            # Try to use existing Node.js first, then install if needed
            if command -v node &> /dev/null; then
              echo "Node.js already installed: $(node --version)"
              echo "NPM version: $(npm --version)"
            else
              echo "Installing Node.js via package manager..."
              # Update package list
              sudo apt-get update
              
              # Install Node.js 18.x from NodeSource repository
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
              
              echo "Node.js installed: $(node --version)"
              echo "NPM version: $(npm --version)"
            fi
            
            # Verify APP_DIR is set and exists
            if [ -z "$APP_DIR" ]; then
              echo "ERROR: APP_DIR is not set"
              exit 1
            fi
            
            if [ ! -d "$APP_DIR" ]; then
              echo "ERROR: Directory $APP_DIR does not exist"
              exit 1
            fi
            
            echo "Changing to directory: $APP_DIR"
            cd "$APP_DIR"
            
            echo "Pulling latest code from GitHub..."
            git reset --hard
            git pull origin main
            
            echo "Writing .env with OLLAMA backend..."
            echo "VITE_OLLAMA_BACKEND_URL=http://${OLLAMA_PRIVATE_IP}:11434" > .env
            
            echo "Installing dependencies..."
            npm install
            
            echo "Building frontend..."
            npm run build
            
            echo "Restarting frontend server..."
            pkill -f "serve" || true
            nohup npx serve -s dist -l 4173 > serve.log 2>&1 &
            
            echo "Deployment completed successfully!"